name: CI - Sigma Validate & Convert

on:
  push:
    branches: ["**"]
    paths:
      - "rules/sigma/**/*.yml"
      - "rules/sigma/**/*.yaml"
      - "docs/schemas/sigma_schema.json"
      - "scripts/validate/**"
      - "scripts/convert/sigma_to_spl.py"
  pull_request:
    paths:
      - "rules/sigma/**/*.yml"
      - "rules/sigma/**/*.yaml"
      - "docs/schemas/sigma_schema.json"
      - "scripts/validate/**"
      - "scripts/convert/sigma_to_spl.py"

permissions:
  contents: write

jobs:
  Sigma-Validate-and-Convert-to-SPL:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Determine changed files
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          echo "BASE_SHA=$BASE_SHA"
          echo "HEAD_SHA=$HEAD_SHA"

          git fetch --no-tags --prune --depth=0 origin || true

          mode="changed"

          # If BASE_SHA is missing/unusable, fall back to ALL rules
          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" =~ ^0+$ ]]; then
            mode="all"
          fi

          mapfile -t files < <(git diff --name-only --diff-filter=AMRC "$BASE_SHA" "$HEAD_SHA" 2>/dev/null || true)

          if [[ "${#files[@]}" -eq 0 && "$mode" != "all" ]]; then
            echo "No changed files detected."
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "rule_files=" >> "$GITHUB_OUTPUT"
            echo "mode=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "${#files[@]}" -gt 0 ]]; then
            echo "Changed files:"
            printf ' - %s\n' "${files[@]}"
          fi

          # If schema or validator or converter changed => validate/convert ALL rules
          if [[ "$mode" != "all" ]]; then
            for f in "${files[@]}"; do
              if [[ "$f" == "docs/schemas/sigma_schema.json" ]] || [[ "$f" == scripts/validate/* ]] || [[ "$f" == "scripts/convert/sigma_to_spl.py" ]]; then
                mode="all"
                break
              fi
            done
          fi

          rule_files=()
          if [[ "$mode" == "all" ]]; then
            while IFS= read -r rf; do
              [[ -n "$rf" ]] && rule_files+=("$rf")
            done < <(git ls-files "rules/sigma/**/*.yml" "rules/sigma/**/*.yaml" || true)
          else
            for f in "${files[@]}"; do
              if [[ "$f" =~ ^rules/sigma/.*\.(yml|yaml)$ ]]; then
                rule_files+=("$f")
              fi
            done
          fi

          if [[ "${#rule_files[@]}" -eq 0 ]]; then
            echo "No Sigma rule files to process."
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "rule_files=" >> "$GITHUB_OUTPUT"
            echo "mode=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          joined_files=""
          for f in "${files[@]}"; do joined_files+="$f "; done

          joined_rules=""
          for r in "${rule_files[@]}"; do joined_rules+="$r "; done

          echo "Mode: $mode"
          echo "files=$joined_files" >> "$GITHUB_OUTPUT"
          echo "rule_files=$joined_rules" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"

      - name: Install Python deps (pyyaml + jsonschema + sigma)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml jsonschema sigma-cli pysigma-backend-splunk

      - name: Validate Sigma rules against schema (changed or all)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $schemaPath = "docs/schemas/sigma_schema.json"
          $maxErrors = 25

          $rulesRaw = "${{ steps.changes.outputs.rule_files }}"

          if ([string]::IsNullOrWhiteSpace($rulesRaw)) {
            Write-Host "No rule files to validate -> skipping."
            exit 0
          }

          $rules = $rulesRaw -split '\s+' | Where-Object { -not [string]::IsNullOrWhiteSpace($_) }

          Write-Host "Validating $($rules.Count) rule file(s) against schema."

          ./scripts/validate/validate_sigma.ps1 `
            -SchemaPath $schemaPath `
            -Files $rules `
            -MaxErrors $maxErrors

      - name: Convert Sigma rules to Splunk SPL (auto pipeline; changed or all)
        id: convert
        shell: bash
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          rules="${{ steps.changes.outputs.rule_files }}"
          if [[ -z "${rules// }" ]]; then
            echo "No rule files to convert -> skipping."
            echo "has_spl=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mkdir -p rules/splunk
          python scripts/convert/sigma_to_spl.py --outdir rules/splunk $rules

          if find rules/splunk -type f -name '*.spl' -print -quit | grep -q .; then
            echo "Generated SPL files:"
            find rules/splunk -type f -name '*.spl' -maxdepth 2 -print
            echo "has_spl=true" >> "$GITHUB_OUTPUT"
          else
            echo "No SPL files generated."
            echo "has_spl=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit converted SPL outputs to repo (push only)
        if: github.event_name == 'push' && steps.convert.outputs.has_spl == 'true'
        shell: bash
        run: |
          set -euo pipefail

              # Stage only converted outputs
              git add -A rules/splunk

              # If nothing changed, do nothing
              if git diff --cached --quiet; then
                echo "No SPL changes to commit."
                exit 0
              fi

              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              git commit -m "chore(splunk): update sigma-converted SPL outputs"

              for i in 1 2 3; do
                git fetch origin main
                git pull --rebase origin main || true
                if git push origin HEAD:main; then
                  echo "Push succeeded."
                  break
                fi
                echo "Push failed (attempt $i), retrying..."
                sleep 2
              done
