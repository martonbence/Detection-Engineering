# .github/workflows/sigma_schema_validation.yml

name: Sigma Schema Validation

on:
  push:
    branches: ["**"]
    paths:
      - "rules/**/*.yml"
      - "rules/**/*.yaml"
      - "docs/schemas/sigma_schema.json"
      - "scripts/validate/**"
      - "scripts/convert/sigma_to_spl.py"
  pull_request:
    paths:
      - "rules/**/*.yml"
      - "rules/**/*.yaml"
      - "docs/schemas/sigma_schema.json"
      - "scripts/validate/**"
      - "scripts/convert/sigma_to_spl.py"

permissions:
  contents: read

jobs:
  validate-sigma:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Determine changed files
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          echo "BASE_SHA=$BASE_SHA"
          echo "HEAD_SHA=$HEAD_SHA"

          git fetch --no-tags --prune --depth=0 origin || true

          mapfile -t files < <(git diff --name-only --diff-filter=AMRC "$BASE_SHA" "$HEAD_SHA" || true)

          if [[ "${#files[@]}" -eq 0 ]]; then
            echo "No changed files detected."
            echo "files=" >> "$GITHUB_OUTPUT"
            echo "rule_files=" >> "$GITHUB_OUTPUT"
            echo "mode=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Changed files:"
          printf ' - %s\n' "${files[@]}"

          # If schema or validator or converter changed => validate/convert ALL rules
          mode="changed"
          for f in "${files[@]}"; do
            if [[ "$f" == "docs/schemas/sigma_schema.json" ]] || [[ "$f" == scripts/validate/* ]] || [[ "$f" == "scripts/convert/sigma_to_spl.py" ]]; then
              mode="all"
              break
            fi
          done

          # Build rule file list
          rule_files=()
          if [[ "$mode" == "all" ]]; then
            # all tracked rule files
            while IFS= read -r rf; do
              [[ -n "$rf" ]] && rule_files+=("$rf")
            done < <(git ls-files rules | grep -E '^rules/.*\.(yml|yaml)$' || true)
          else
            # only changed rules
            for f in "${files[@]}"; do
              if [[ "$f" =~ ^rules/.*\.(yml|yaml)$ ]]; then
                rule_files+=("$f")
              fi
            done
          fi

          # Join for outputs (space-separated)
          joined_files=""
          for f in "${files[@]}"; do
            joined_files+="$f "
          done

          joined_rules=""
          for r in "${rule_files[@]}"; do
            joined_rules+="$r "
          done

          echo "Mode: $mode"
          echo "files=$joined_files" >> "$GITHUB_OUTPUT"
          echo "rule_files=$joined_rules" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"

      - name: Install Python deps (pyyaml + jsonschema + sigma)
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml jsonschema sigma-cli pysigma-backend-splunk

      - name: Validate Sigma rules against schema (changed or all)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $schemaPath = "docs/schemas/sigma_schema.json"
          $maxErrors = 25

          $rulesRaw = "${{ steps.changes.outputs.rule_files }}"

          if ([string]::IsNullOrWhiteSpace($rulesRaw)) {
            Write-Host "No rule files to validate -> skipping."
            exit 0
          }

          $rules = $rulesRaw -split '\s+' | Where-Object { -not [string]::IsNullOrWhiteSpace($_) }

          Write-Host "Validating $($rules.Count) rule file(s) against schema."

          ./scripts/validate/validate_sigma.ps1 `
            -SchemaPath $schemaPath `
            -Files $rules `
            -MaxErrors $maxErrors

      - name: Convert Sigma rules to Splunk SPL (auto pipeline; changed or all)
        shell: bash
        run: |
          set -euo pipefail

          rules="${{ steps.changes.outputs.rule_files }}"
          if [[ -z "${rules// }" ]]; then
            echo "No rule files to convert -> skipping."
            exit 0
          fi

          mkdir -p rules/splunk
          python scripts/convert/sigma_to_spl.py --outdir rules/splunk $rules

          echo "Generated SPL files:"
          ls -la rules/splunk
