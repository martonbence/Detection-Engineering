name: CI - Deploy SPL to Splunk

on:
  workflow_run:
    workflows: ["CI - Sigma Validate & Convert"]
    types: [completed]

permissions:
  contents: read

jobs:
  SPL-Deploy-to-Splunk:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: self-hosted

    steps:
      - name: Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Determine changed SPL files (since previous commit)
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          HEAD_SHA="$(git rev-parse HEAD)"
          BASE_SHA="$(git rev-parse HEAD~1 2>/dev/null || true)"

          if [[ -z "${BASE_SHA}" ]]; then
            echo "No BASE_SHA available; deploying all SPL files."
            mapfile -t spl_files < <(git ls-files "rules/splunk" | grep -E '\.spl$' || true)
          else
            mapfile -t files < <(git diff --name-only --diff-filter=AMRC "$BASE_SHA" "$HEAD_SHA" || true)
            spl_files=()
            for f in "${files[@]}"; do
              if [[ "$f" =~ ^rules/splunk/.*\.spl$ ]]; then
                spl_files+=("$f")
              fi
            done
          fi

          if [[ "${#spl_files[@]}" -eq 0 ]]; then
            echo "No SPL files to deploy."
            echo "spl_files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            echo "spl_files<<EOF"
            printf '%s\n' "${spl_files[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "SPL files to deploy:"
          printf ' - %s\n' "${spl_files[@]}"

      - name: Setup Python
        if: steps.changes.outputs.spl_files != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.changes.outputs.spl_files != ''
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Deploy changed SPL files to Splunk (create-or-update)
        if: steps.changes.outputs.spl_files != ''
        shell: bash
        env:
          SPLUNK_BASE_URL: ${{ secrets.SPLUNK_BASE_URL }}
          SPLUNK_USERNAME: ${{ secrets.SPLUNK_USERNAME }}
          SPLUNK_PASSWORD: ${{ secrets.SPLUNK_PASSWORD }}
          SPLUNK_APP: ${{ secrets.SPLUNK_APP }}
          SPLUNK_OWNER: ${{ secrets.SPLUNK_OWNER }}
          SPLUNK_VERIFY_TLS: ${{ secrets.SPLUNK_VERIFY_TLS || 'false' }}
          SPLUNK_SHARING: app
          SPLUNK_PERMS_READ: "*"
          SPLUNK_PERMS_WRITE: admin,ci_deploy_savedsearches

        run: |
          set -euo pipefail
          mapfile -t spl_files <<'EOF'
          ${{ steps.changes.outputs.spl_files }}
          EOF

          python scripts/deploy/deploy_spl_to_splunk.py "${spl_files[@]}"
