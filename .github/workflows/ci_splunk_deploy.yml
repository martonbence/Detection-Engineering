name: CI - Deploy SPL to Splunk

on:
  push:
    branches: ["main"]
    paths:
      - "rules/splunk/**/*.spl"
      - "scripts/deploy/**"

permissions:
  contents: read

jobs:
  deploy-to-splunk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed SPL files
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"

          git fetch --no-tags --prune --depth=0 origin || true

          mapfile -t files < <(git diff --name-only --diff-filter=AMRC "$BASE_SHA" "$HEAD_SHA" || true)

          spl_files=()
          for f in "${files[@]}"; do
            if [[ "$f" =~ ^rules/splunk/.*\.spl$ ]]; then
              spl_files+=("$f")
            fi
          done

          if [[ "${#spl_files[@]}" -eq 0 ]]; then
            echo "No changed SPL files detected."
            echo "spl_files=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {
            echo "spl_files<<EOF"
            printf '%s\n' "${spl_files[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "Changed SPL files:"
          printf ' - %s\n' "${spl_files[@]}"

      - name: Setup Python
        if: steps.changes.outputs.spl_files != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.changes.outputs.spl_files != ''
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Deploy changed SPL files to Splunk (create-or-update)
        if: steps.changes.outputs.spl_files != ''
        shell: bash
        env:
          SPLUNK_BASE_URL: ${{ secrets.SPLUNK_BASE_URL }} # https://host:8089
          SPLUNK_USERNAME: ${{ secrets.SPLUNK_USERNAME }}
          SPLUNK_PASSWORD: ${{ secrets.SPLUNK_PASSWORD }}
          SPLUNK_APP: ${{ secrets.SPLUNK_APP }} # pl. search vagy saját app
          SPLUNK_OWNER: ${{ secrets.SPLUNK_OWNER }} # pl. nobody
          SPLUNK_VERIFY_TLS: ${{ secrets.SPLUNK_VERIFY_TLS }} # "true" vagy "false" (opcionális)
        run: |
          set -euo pipefail

          mapfile -t spl_files <<'EOF'
          ${{ steps.changes.outputs.spl_files }}
          EOF

          python scripts/deploy/deploy_spl_to_splunk.py "${spl_files[@]}"
